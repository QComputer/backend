<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload Test - Frontend Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px 0;
        }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.warning { background-color: #fff3cd; color: #856404; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“¸ Image Upload Test - Frontend Simulation</h1>
        
        <div class="test-section">
            <h3>Configuration</h3>
            <p><strong>Backend URL:</strong> <span id="backend-url">https://sefr.runflare.run</span></p>
            <p><strong>Image Service URL:</strong> <span id="image-service-url">https://zero-community-image.onrender.com</span></p>
            <p><strong>Frontend URL:</strong> <span id="frontend-url">https://sefr.liara.run</span></p>
        </div>

        <div class="test-section">
            <h3>1. Test CORS Configuration</h3>
            <button onclick="testCORS()">Test CORS</button>
            <div id="cors-status" class="status"></div>
            <div id="cors-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>2. Test Image Service Health</h3>
            <button onclick="testImageServiceHealth()">Test Image Service</button>
            <div id="image-service-status" class="status"></div>
            <div id="image-service-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>3. Test Direct Image Upload to Image Service</h3>
            <input type="file" id="test-image-input" accept="image/*">
            <button onclick="testDirectUpload()">Upload to Image Service</button>
            <div id="direct-upload-status" class="status"></div>
            <div id="direct-upload-log" class="log"></div>
            <div id="direct-upload-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>4. Test Backend Image Upload (Requires Authentication)</h3>
            <p><em>Note: This test requires a valid user session. You'll need to be logged in to test this.</em></p>
            <input type="file" id="backend-test-image-input" accept="image/*">
            <button onclick="testBackendUpload()">Upload via Backend</button>
            <div id="backend-upload-status" class="status"></div>
            <div id="backend-upload-log" class="log"></div>
            <div id="backend-upload-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>5. Create Test User (For Backend Upload Test)</h3>
            <input type="text" id="test-username" placeholder="Username">
            <input type="password" id="test-password" placeholder="Password">
            <button onclick="createTestUser()">Create Test User</button>
            <div id="user-creation-status" class="status"></div>
            <div id="user-creation-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>6. Login Test User</h3>
            <input type="text" id="login-username" placeholder="Username">
            <input type="password" id="login-password" placeholder="Password">
            <button onclick="loginTestUser()">Login</button>
            <div id="login-status" class="status"></div>
            <div id="login-log" class="log"></div>
        </div>
    </div>

    <script>
        const CONFIG = {
            backendUrl: 'https://sefr.runflare.run',
            imageServiceUrl: 'https://zero-community-image.onrender.com',
            frontendUrl: 'https://sefr.liara.run'
        };

        let authToken = null;

        function log(elementId, message, isError = false) {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const status = isError ? 'ERROR' : 'INFO';
            logElement.innerHTML += `[${timestamp}] ${status}: ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function setStatus(elementId, message, isSuccess = true) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status ${isSuccess ? 'success' : 'error'}`;
        }

        async function testCORS() {
            const statusElement = document.getElementById('cors-status');
            const logElement = document.getElementById('cors-log');
            
            logElement.innerHTML = '';
            setStatus('cors-status', 'Testing CORS...', false);
            
            try {
                // Test preflight OPTIONS request
                const response = await fetch(`${CONFIG.backendUrl}/api/v1/image/upload`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': CONFIG.frontendUrl,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type,Authorization'
                    }
                });

                log('cors-log', `OPTIONS request status: ${response.status} ${response.statusText}`);
                log('cors-log', `Access-Control-Allow-Origin: ${response.headers.get('access-control-allow-origin')}`);
                log('cors-log', `Access-Control-Allow-Methods: ${response.headers.get('access-control-allow-methods')}`);
                log('cors-log', `Access-Control-Allow-Headers: ${response.headers.get('access-control-allow-headers')}`);
                log('cors-log', `Access-Control-Allow-Credentials: ${response.headers.get('access-control-allow-credentials')}`);

                if (response.ok && response.headers.get('access-control-allow-origin')) {
                    setStatus('cors-status', 'CORS is properly configured âœ“', true);
                } else {
                    setStatus('cors-status', 'CORS configuration issues detected âœ—', false);
                }
            } catch (error) {
                log('cors-log', `CORS test failed: ${error.message}`, true);
                setStatus('cors-status', 'CORS test failed âœ—', false);
            }
        }

        async function testImageServiceHealth() {
            const statusElement = document.getElementById('image-service-status');
            const logElement = document.getElementById('image-service-log');
            
            logElement.innerHTML = '';
            setStatus('image-service-status', 'Testing image service...', false);
            
            try {
                const response = await fetch(`${CONFIG.imageServiceUrl}/health`);
                log('image-service-log', `Health check status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('image-service-log', `Service status: ${data.status}`);
                    log('image-service-log', `Service version: ${data.version || 'unknown'}`);
                    setStatus('image-service-status', 'Image service is healthy âœ“', true);
                } else {
                    setStatus('image-service-status', 'Image service issues detected âœ—', false);
                }
            } catch (error) {
                log('image-service-log', `Image service test failed: ${error.message}`, true);
                setStatus('image-service-status', 'Image service test failed âœ—', false);
            }
        }

        async function testDirectUpload() {
            const fileInput = document.getElementById('test-image-input');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an image file first');
                return;
            }

            const statusElement = document.getElementById('direct-upload-status');
            const logElement = document.getElementById('direct-upload-log');
            const resultElement = document.getElementById('direct-upload-result');
            
            logElement.innerHTML = '';
            resultElement.style.display = 'none';
            setStatus('direct-upload-status', 'Uploading image...', false);
            
            try {
                const formData = new FormData();
                formData.append('image', file);

                log('direct-upload-log', `Starting upload for: ${file.name} (${file.type}, ${file.size} bytes)`);

                const response = await fetch(`${CONFIG.imageServiceUrl}/upload`, {
                    method: 'POST',
                    body: formData
                });

                log('direct-upload-log', `Upload response: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const result = await response.json();
                    log('direct-upload-log', `Upload successful!`);
                    log('direct-upload-log', `Image URL: ${result.data.url}`);
                    
                    resultElement.innerHTML = `
                        <strong>Upload Successful!</strong><br>
                        Image URL: <a href="${result.data.url}" target="_blank">${result.data.url}</a><br>
                        Image ID: ${result.data.id || 'N/A'}
                    `;
                    resultElement.style.display = 'block';
                    setStatus('direct-upload-status', 'Direct upload successful âœ“', true);
                } else {
                    const errorData = await response.text();
                    log('direct-upload-log', `Upload failed: ${errorData}`, true);
                    setStatus('direct-upload-status', 'Direct upload failed âœ—', false);
                }
            } catch (error) {
                log('direct-upload-log', `Direct upload error: ${error.message}`, true);
                setStatus('direct-upload-status', 'Direct upload error âœ—', false);
            }
        }

        async function testBackendUpload() {
            const fileInput = document.getElementById('backend-test-image-input');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an image file first');
                return;
            }

            if (!authToken) {
                alert('Please login first to test backend upload');
                return;
            }

            const statusElement = document.getElementById('backend-upload-status');
            const logElement = document.getElementById('backend-upload-log');
            const resultElement = document.getElementById('backend-upload-result');
            
            logElement.innerHTML = '';
            resultElement.style.display = 'none';
            setStatus('backend-upload-status', 'Uploading via backend...', false);
            
            try {
                const formData = new FormData();
                formData.append('image', file);

                log('backend-upload-log', `Starting backend upload for: ${file.name} (${file.type}, ${file.size} bytes)`);
                log('backend-upload-log', `Using auth token: ${authToken.substring(0, 20)}...`);

                const response = await fetch(`${CONFIG.backendUrl}/api/v1/image/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Origin': CONFIG.frontendUrl
                    },
                    body: formData
                });

                log('backend-upload-log', `Backend upload response: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const result = await response.json();
                    log('backend-upload-log', `Backend upload successful!`);
                    log('backend-upload-log', `Image URL: ${result.data.url}`);
                    
                    resultElement.innerHTML = `
                        <strong>Backend Upload Successful!</strong><br>
                        Image URL: <a href="${result.data.url}" target="_blank">${result.data.url}</a><br>
                        Image ID: ${result.data.id}<br>
                        Message: ${result.message}
                    `;
                    resultElement.style.display = 'block';
                    setStatus('backend-upload-status', 'Backend upload successful âœ“', true);
                } else {
                    const errorData = await response.text();
                    log('backend-upload-log', `Backend upload failed: ${errorData}`, true);
                    setStatus('backend-upload-status', 'Backend upload failed âœ—', false);
                }
            } catch (error) {
                log('backend-upload-log', `Backend upload error: ${error.message}`, true);
                setStatus('backend-upload-status', 'Backend upload error âœ—', false);
            }
        }

        async function createTestUser() {
            const username = document.getElementById('test-username').value;
            const password = document.getElementById('test-password').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            const statusElement = document.getElementById('user-creation-status');
            const logElement = document.getElementById('user-creation-log');
            
            logElement.innerHTML = '';
            setStatus('user-creation-status', 'Creating test user...', false);
            
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/v1/user/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': CONFIG.frontendUrl
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        email: `${username}@test.com`,
                        name: username
                    })
                });

                log('user-creation-log', `User creation response: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const result = await response.json();
                    log('user-creation-log', `User created successfully!`);
                    log('user-creation-log', `User ID: ${result.data.user._id}`);
                    setStatus('user-creation-status', 'Test user created successfully âœ“', true);
                } else {
                    const errorData = await response.text();
                    log('user-creation-log', `User creation failed: ${errorData}`, true);
                    setStatus('user-creation-status', 'User creation failed âœ—', false);
                }
            } catch (error) {
                log('user-creation-log', `User creation error: ${error.message}`, true);
                setStatus('user-creation-status', 'User creation error âœ—', false);
            }
        }

        async function loginTestUser() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            const statusElement = document.getElementById('login-status');
            const logElement = document.getElementById('login-log');
            
            logElement.innerHTML = '';
            setStatus('login-status', 'Logging in...', false);
            
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/v1/user/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': CONFIG.frontendUrl
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                log('login-log', `Login response: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const result = await response.json();
                    authToken = result.data.token;
                    log('login-log', `Login successful!`);
                    log('login-log', `Token: ${authToken.substring(0, 20)}...`);
                    setStatus('login-status', 'Login successful âœ“', true);
                } else {
                    const errorData = await response.text();
                    log('login-log', `Login failed: ${errorData}`, true);
                    setStatus('login-status', 'Login failed âœ—', false);
                }
            } catch (error) {
                log('login-log', `Login error: ${error.message}`, true);
                setStatus('login-status', 'Login error âœ—', false);
            }
        }
    </script>
</body>
</html>